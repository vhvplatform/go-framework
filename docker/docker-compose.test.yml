version: '3.8'

# Testing override file
# Use with: docker-compose -f docker-compose.yml -f docker-compose.test.yml up

services:
  # Use separate database for testing
  mongodb:
    environment:
      MONGO_INITDB_DATABASE: saas_test
    volumes:
      - mongodb_test_data:/data/db

  redis:
    volumes:
      - redis_test_data:/data

  rabbitmq:
    volumes:
      - rabbitmq_test_data:/var/lib/rabbitmq

  # Override services with test configuration
  api-gateway:
    environment:
      - ENVIRONMENT=test
      - LOG_LEVEL=info
      - MONGODB_DATABASE=saas_test
      - ENABLE_METRICS=true

  auth-service:
    environment:
      - ENVIRONMENT=test
      - LOG_LEVEL=info
      - MONGODB_DATABASE=saas_test

  user-service:
    environment:
      - ENVIRONMENT=test
      - LOG_LEVEL=info
      - MONGODB_DATABASE=saas_test

  tenant-service:
    environment:
      - ENVIRONMENT=test
      - LOG_LEVEL=info
      - MONGODB_DATABASE=saas_test

  notification-service:
    environment:
      - ENVIRONMENT=test
      - LOG_LEVEL=info
      - MONGODB_DATABASE=saas_test
      # Use mock SMTP for testing
      - SMTP_HOST=localhost
      - SMTP_PORT=1025

  system-config-service:
    environment:
      - ENVIRONMENT=test
      - LOG_LEVEL=info
      - MONGODB_DATABASE=saas_test

  # Disable observability in test mode to reduce overhead
  prometheus:
    profiles:
      - observability

  grafana:
    profiles:
      - observability

  jaeger:
    profiles:
      - observability

volumes:
  mongodb_test_data:
  redis_test_data:
  rabbitmq_test_data:
