@startuml cicd-process
!theme plain
skinparam backgroundColor #FFFFFF
skinparam defaultFontName Arial
skinparam defaultFontSize 12

title CI/CD Build and Deployment Process

' Define colors
!define PRIMARY_COLOR #4A90E2
!define SECONDARY_COLOR #50C878
!define TERTIARY_COLOR #FFB84D
!define DANGER_COLOR #FF6B6B
!define SUCCESS_COLOR #2ECC71

actor Developer
participant "GitHub\nRepository" as github
participant "CI/CD\n(GitHub Actions)" as ci
participant "Build\nScripts" as build
participant "Test\nScripts" as test
participant "Docker\nRegistry" as registry
participant "Kubernetes\nCluster" as k8s
database "Artifact\nStorage" as artifacts

' Development Phase
group Development Phase [#PRIMARY_COLOR]
    Developer -> Developer: Write code
    Developer -> Developer: Run local tests\n**make test-unit**
    Developer -> Developer: Build locally\n**make build**
    
    note right of Developer
        Local development uses:
        - make start-dev (hot reload)
        - make test-unit (fast feedback)
        - make rebuild SERVICE=xxx
    end note
end

' Commit and Push
group Version Control [#SECONDARY_COLOR]
    Developer -> github: Commit changes
    Developer -> github: Push to branch
    
    note right of github
        Triggers on:
        - Push to main/develop
        - Pull request creation
        - Tag creation (releases)
    end note
end

' CI Pipeline - Code Quality
group CI: Code Quality Checks [#TERTIARY_COLOR]
    github -> ci: Trigger workflow
    activate ci
    
    ci -> ci: Checkout code
    
    ci -> ci: Setup Go 1.25+
    
    ci -> ci: Cache dependencies
    note right
        Cache go modules
        for faster builds
    end note
    
    ci -> ci: Run linters
    note right
        - golangci-lint
        - shellcheck (scripts)
        - yamllint (configs)
    end note
    
    alt Linting passes
        ci -> ci: ✓ Linting passed
    else Linting fails
        ci -> github: ✗ Report failure
        github -> Developer: Notification
        deactivate ci
        Developer -> Developer: Fix linting issues
        Developer -> github: Push fixes
    end
end

' CI Pipeline - Build
group CI: Build Phase [#PRIMARY_COLOR]
    ci -> build: Execute build scripts
    activate build
    
    build -> build: Run **go mod download**
    build -> build: Run **go mod verify**
    
    build -> build: Build all services
    note right
        ./scripts/build/build-all.sh
        - Compiles Go binaries
        - Runs build for each service
        - Generates build artifacts
    end note
    
    alt Build succeeds
        build -> ci: ✓ Build successful
        deactivate build
    else Build fails
        build -> ci: ✗ Build failed
        deactivate build
        ci -> github: Report failure
        github -> Developer: Notification
        deactivate ci
    end
end

' CI Pipeline - Testing
group CI: Testing Phase [#TERTIARY_COLOR]
    ci -> test: Execute test scripts
    activate test
    
    test -> test: Setup test environment
    note right
        Start test services:
        - Test databases
        - Mock services
    end note
    
    test -> test: Run unit tests
    note right
        ./scripts/testing/run-unit-tests.sh
        - Fast, isolated tests
        - No external dependencies
    end note
    
    test -> test: Run integration tests
    note right
        ./scripts/testing/run-integration-tests.sh
        - Tests with real services
        - Database interactions
        - API integration
    end note
    
    test -> test: Generate coverage report
    note right
        Target: >80% coverage
        - Line coverage
        - Branch coverage
    end note
    
    test -> test: Run security scans
    note right
        - CodeQL analysis
        - Dependency vulnerability scan
        - Secret detection
    end note
    
    alt All tests pass
        test -> ci: ✓ All tests passed
        test -> artifacts: Upload coverage report
    else Tests fail
        test -> ci: ✗ Tests failed
        test -> artifacts: Upload failure logs
        ci -> github: Report failure
        github -> Developer: Notification
        deactivate ci
        deactivate test
    end
    deactivate test
end

' Docker Build
group CI: Docker Image Build [#SECONDARY_COLOR]
    ci -> build: Build Docker images
    activate build
    
    build -> build: Build service images
    note right
        ./scripts/build/docker-build-all.sh
        - Multi-stage builds
        - Optimized layers
        - Security scanning
    end note
    
    build -> build: Tag images
    note right
        Tagging strategy:
        - commit SHA
        - branch name
        - version tag (if release)
        - latest (if main branch)
    end note
    
    build -> build: Run container security scan
    note right
        - Trivy scan
        - Check for vulnerabilities
        - Validate base images
    end note
    
    alt Security scan passes
        build -> registry: Push images
        activate registry
        registry -> registry: Store images
        registry -> ci: ✓ Images pushed
        deactivate registry
        build -> ci: ✓ Docker build complete
        deactivate build
    else Security issues found
        build -> ci: ✗ Security vulnerabilities
        deactivate build
        ci -> github: Report security issues
        deactivate ci
    end
end

' Deployment - Development
group CD: Deploy to Development [#SUCCESS_COLOR]
    alt Branch is develop
        ci -> build: Trigger deployment
        activate build
        
        build -> build: Prepare deployment configs
        note right
            Use configs for dev environment:
            - Lower resources
            - Debug enabled
            - Test data
        end note
        
        build -> k8s: Deploy to dev cluster
        activate k8s
        
        k8s -> k8s: Apply Kubernetes manifests
        note right
            - Update deployments
            - Rolling update strategy
            - Health checks
        end note
        
        k8s -> k8s: Wait for rollout
        note right
            Monitor deployment:
            - Pod readiness
            - Health endpoints
            - Service availability
        end note
        
        k8s -> build: ✓ Deployment successful
        deactivate k8s
        
        build -> ci: ✓ Dev deployment complete
        deactivate build
        
        ci -> github: Update deployment status
        github -> Developer: Success notification
        deactivate ci
    end
end

' Deployment - Staging/Production
group CD: Deploy to Production [#SUCCESS_COLOR]
    alt Tag pushed (release)
        github -> ci: Trigger release workflow
        activate ci
        
        ci -> ci: Run additional checks
        note right
            Production readiness:
            - All tests pass
            - Performance tests
            - Security audit
            - Documentation updated
        end note
        
        ci -> ci: Create release notes
        note right
            Generate from:
            - Commits since last release
            - Closed issues
            - Pull requests
        end note
        
        ci -> build: Deploy to staging
        activate build
        
        build -> k8s: Deploy to staging cluster
        activate k8s
        
        k8s -> k8s: Blue-green deployment
        note right
            - Deploy to green environment
            - Run smoke tests
            - Switch traffic
            - Keep blue as backup
        end note
        
        k8s -> build: ✓ Staging deployment successful
        deactivate k8s
        
        build -> ci: ✓ Staging ready
        deactivate build
        
        ci -> ci: Wait for manual approval
        note right
            Manual gate for production:
            - Review staging
            - Check metrics
            - Approve deployment
        end note
        
        Developer -> ci: Approve production deployment
        
        ci -> build: Deploy to production
        activate build
        
        build -> k8s: Deploy to production cluster
        activate k8s
        
        k8s -> k8s: Canary deployment
        note right
            Progressive rollout:
            - 10% traffic
            - Monitor metrics
            - 50% traffic
            - Monitor more
            - 100% traffic
        end note
        
        k8s -> build: ✓ Production deployment successful
        deactivate k8s
        
        build -> ci: ✓ Production updated
        deactivate build
        
        ci -> github: Create GitHub release
        ci -> github: Tag Docker images
        ci -> artifacts: Archive release artifacts
        
        ci -> github: Update status
        github -> Developer: Release notification
        deactivate ci
    end
end

' Monitoring and Rollback
group Post-Deployment Monitoring [#TERTIARY_COLOR]
    k8s -> k8s: Monitor metrics
    note right
        Continuous monitoring:
        - Error rates
        - Response times
        - Resource usage
        - Health checks
    end note
    
    alt Issues detected
        k8s -> github: Alert: High error rate
        github -> Developer: Critical alert
        
        Developer -> ci: Trigger rollback
        activate ci
        
        ci -> k8s: Rollback to previous version
        activate k8s
        
        k8s -> k8s: Instant rollback
        note right
            - Switch to previous deployment
            - Restore stability
            - Investigate issues
        end note
        
        k8s -> ci: ✓ Rollback complete
        deactivate k8s
        
        ci -> github: Rollback successful
        deactivate ci
        github -> Developer: Stability restored
    end
end

' Legend
legend right
    **Deployment Environments**
    - **Local**: Developer machines (make start-dev)
    - **Dev**: Automatic deployment from develop branch
    - **Staging**: Deployment from release tags
    - **Production**: Manual approval required
    
    **Key Scripts Used**
    - build-all.sh: Build all services
    - docker-build-all.sh: Create Docker images
    - run-*-tests.sh: Execute test suites
    - deploy-*.sh: Deploy to environments
    
    **Quality Gates**
    1. Linting and code quality
    2. Unit tests (>80% coverage)
    3. Integration tests
    4. Security scans
    5. Container vulnerability scan
    6. Performance tests (production)
end legend

@enduml
