@startuml data-flow
!theme plain
skinparam backgroundColor #FFFFFF

title Request Flow - User Login Example

actor "Client" as client
participant "API Gateway\n:8080" as gateway
participant "Auth Service\n:8081" as auth
database "MongoDB" as mongo
database "Redis" as redis
queue "RabbitMQ" as rabbit
participant "Notification\nService" as notification

== Authentication Request ==

client -> gateway: POST /api/auth/login
note right
  {
    "email": "user@example.com",
    "password": "password123"
  }
end note

activate gateway
gateway -> gateway: Validate request format
gateway -> gateway: Extract credentials

gateway -> auth: LoginRequest (gRPC)
note right
  {
    email: "user@example.com"
    password: "password123"
  }
end note

activate auth

== Database Query ==

auth -> mongo: Find user by email
activate mongo
note right
  db.users.findOne({
    email: "user@example.com"
  })
  
  Uses index: email_unique_idx
  Query time: ~5ms
end note

mongo --> auth: User document
deactivate mongo

note left of auth
  User {
    id: "user-123"
    email: "user@example.com"
    password_hash: "$2a$10$..."
    tenant_id: "tenant-456"
    roles: ["user", "editor"]
  }
end note

== Password Verification ==

auth -> auth: Verify password with bcrypt
note right
  bcrypt.Compare(
    hashedPassword,
    providedPassword
  )
  
  Time: ~100ms (intentionally slow)
end note

alt Password Valid
    
    == Session Creation ==
    
    auth -> auth: Generate JWT token
    note right
      Token payload:
      {
        user_id: "user-123"
        tenant_id: "tenant-456"
        roles: ["user", "editor"]
        exp: 1640000000
      }
      
      Signed with: JWT_SECRET
    end note
    
    auth -> redis: Store session
    activate redis
    note right
      Key: session:user-123:abc123
      Value: {
        user_id: "user-123"
        tenant_id: "tenant-456"
        login_time: "2024-01-15T10:30:00Z"
        ip: "192.168.1.100"
      }
      TTL: 24 hours
    end note
    redis --> auth: OK
    deactivate redis
    
    == Audit Logging ==
    
    auth -> rabbit: Publish login event
    activate rabbit
    note right
      Exchange: events
      Routing key: auth.login
      
      Message:
      {
        event: "user.login"
        user_id: "user-123"
        tenant_id: "tenant-456"
        timestamp: "2024-01-15T10:30:00Z"
        ip: "192.168.1.100"
      }
    end note
    
    rabbit -> notification: Consume event
    activate notification
    notification -> notification: Check security alerts
    notification -> notification: Log to audit trail
    deactivate notification
    
    deactivate rabbit
    
    == Success Response ==
    
    auth --> gateway: LoginResponse
    note left
      {
        success: true
        token: "eyJhbGc..."
        user: {
          id: "user-123"
          email: "user@example.com"
          name: "User Name"
        }
        expires_at: "2024-01-16T10:30:00Z"
      }
    end note
    deactivate auth
    
    gateway -> gateway: Transform to HTTP response
    gateway --> client: HTTP 200 OK
    note left
      {
        "token": "eyJhbGc...",
        "user": {
          "id": "user-123",
          "email": "user@example.com",
          "name": "User Name"
        },
        "expires_at": "2024-01-16T10:30:00Z"
      }
    end note
    
else Password Invalid
    
    auth --> gateway: LoginError
    note left
      {
        success: false
        error: "Invalid credentials"
      }
    end note
    deactivate auth
    
    gateway --> client: HTTP 401 Unauthorized
    note left
      {
        "error": "Invalid credentials",
        "message": "Email or password is incorrect"
      }
    end note
    
end

deactivate gateway

== Subsequent Authenticated Request ==

client -> gateway: GET /api/users/profile
note right
  Headers:
  Authorization: Bearer eyJhbGc...
end note

activate gateway

gateway -> gateway: Extract JWT from header
gateway -> gateway: Verify JWT signature
gateway -> gateway: Check expiration
gateway -> gateway: Extract user_id from claims

gateway -> redis: Check token blacklist
activate redis
redis --> gateway: Not blacklisted
deactivate redis

gateway -> gateway: Add user context to request

gateway -> auth: Forward request with context
auth --> gateway: User profile data
gateway --> client: HTTP 200 OK

deactivate gateway

@enduml
